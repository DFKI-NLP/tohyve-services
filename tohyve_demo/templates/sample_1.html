<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Audio Stream Fetcher</title>
</head>
<body>
  <h1>Audio Stream Fetcher</h1>
  <button id="startButton">Start Fetching</button>
  <button id="stopButton">Stop Fetching</button>

  <script>
    let base64data = '';
    document.addEventListener('DOMContentLoaded', () => {
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        
        let stopFetching = false;
        let webSocket;

        startButton.addEventListener('click', () => {
            stopFetching = false;
            initWebSocket();
            fetchData();
        });

        stopButton.addEventListener('click', () => {
            stopFetching = true;
            if (webSocket) {
                webSocket.close();
            }
        });

        function initWebSocket() {
            webSocket = new WebSocket('wss://dfki-3109.dfki.de/ws');

            webSocket.onopen = (event) => {
                console.log('WebSocket opened:', event);
            };

            webSocket.onmessage = (event) => {
                console.log('WebSocket message received:', event.data);
            };

            webSocket.onclose = (event) => {
                console.log('WebSocket closed:', event);
            };

            webSocket.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }

        async function fetchData() {
            try {
                const response = await fetch('https://st01.sslstream.dlf.de/dlf/01/128/mp3/stream.mp3?aggregator=web', { method: 'GET' });

                if (!response.ok) {
                    throw new Error(`Failed to fetch audio: ${response.status} ${response.statusText}`);
                }

                const reader = response.body.getReader();

                while (!stopFetching) {
                    const { value, done } = await reader.read();

                    if (done) {
                        console.log('Streaming finished.');
                        break;
                    }
                    
                    // console.log(value); 
                    // Send the audio chunk to the WebSocket
                    sendAudioToWebSocket(value);

                    // Do something with the audio data (optional)
                    // processAudioData(value);
                }

            } catch (error) {
                console.error('Error fetching audio:', error);
            }
        }

        // Function to convert ArrayBuffer to Base64
        function arrayBufferToBase64(buffer) {
            var binary = '';
            // var bytes = new Uint8Array( buffer );
            var len = buffer.byteLength;
            for (var i = 0; i < len; i++) {
                binary += String.fromCharCode( buffer[ i ] );
            }
            return btoa( binary );
        }

        function sendAudioToWebSocket(audioChunk) {
            base64data = "data:audio/wav;base64," + arrayBufferToBase64(audioChunk);
            // Format the data into a JSON object
            const jsonData = {
                fn_index:4,
                data:[
                    "de",
                    {
                        data:base64data,
                        name:"audio.mp3"
                    }
                ],
                target_language:"en"
            };
            if (webSocket.readyState === WebSocket.OPEN) {
                webSocket.send(JSON.stringify(jsonData));
            }
        }
    });
  </script>
</body>
</html>
