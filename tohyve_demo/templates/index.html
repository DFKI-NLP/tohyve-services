<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <script src="https://cdn.jsdelivr.net/npm/webrtc-adapter/out/adapter.js"></script>
    <title>ToHyVe Service Demo</title>
    <style>
        .dropdown-container {
            display: flex;
            justify-content: space-between;
        }

        .dropdown {
            flex: 1;
            margin-right: 10px;
        }
        .header {
            text-align: center;
        }
     
        label {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1 class="header">ToHyVe Service Demo</h1>
    <div class="dropdown-container">
        <!-- First Dropdown (Default: de) -->
        <label for="source_language">Streaming Language:</label>
        <select class="dropdown" id="source_language">
            <option value="en">English</option>
            <option value="de" selected>German</option>
        </select>
        <label for="target_language">Target Language:</label>
        <!-- Second Dropdown (Default: en) -->
        <select class="dropdown" id="target_language">
            <option value="en" selected>English</option>
            <option value="de">German</option>
        </select>
        <!-- Buttons for start and pause -->
        <button id="startButton">Start</button>
        <button id="pauseButton" disabled>Pause</button>
    </div>

    <!-- Display response from the website -->
    <div id="response">
        <table id="response-table">
            <tr>
            <th></th>
            </tr>
        </table>
    </div>
    
    <audio id="audioPlayer" controls autoplay></audio>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let base64data = '';
        const startButton = document.getElementById('startButton');
        const pauseButton = document.getElementById('pauseButton');
        const responseDiv = document.getElementById('response');
        const sourceLanguage = document.getElementById("source_language");
        const targetLanguage = document.getElementById("target_language");
        var table = document.getElementById("response-table");

        audioPlayer.style.display = 'none';

        async function startStreaming() {
            const socket = new WebSocket('wss://dfki-3109.dfki.de/ws');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                mediaRecorder = new MediaRecorder(stream);

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0 && socket.readyState === WebSocket.OPEN) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = (event) => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    var reader = new FileReader();
                    
                    // Convert data to base64
                    reader.onloadend = function() { 
                        base64data = reader.result;       
                    }
                    reader.readAsDataURL(audioBlob);
                    
                    // Format the data into a JSON object
                    const jsonData = {
                        fn_index:4,
                        data:[
                            sourceLanguage.value,
                            {
                                data:base64data,
                                name:"audio.mp3"
                            }
                        ],
                        target_language:targetLanguage.value
                    };

                    // Send data to the server
                    socket.send(JSON.stringify(jsonData));

                    // Clear audioChunks for the next recording
                    audioChunks = [];                

                };

                socket.onmessage = (event) => {
                    // Parse the JSON response
                    var jsonResponse = JSON.parse(event.data);

                    var keys = Object.keys(jsonResponse);
                    // Iterate over the keys and log them
                    keys.forEach(function (key) {
                        if (key == "asr"){
                            var row = table.insertRow();
                            console.log('key Response:', jsonResponse[key]);
                            var asr_cell = row.insertCell(0);
                            asr_cell.innerHTML = jsonResponse[key];
                        }
                        if (key == "mt"){
                            var row = table.insertRow();
                            console.log('key Response:', jsonResponse[key]);
                            var mt_cell = row.insertCell(0);
                            mt_cell.innerHTML = jsonResponse[key];
                        }
                        if (key == "tts"){
                            var row = table.insertRow();
                            console.log('key Response:', jsonResponse[key]);
                            var tts_cell = row.insertCell(0);
                            tts_cell.innerHTML = jsonResponse[key];
                        }
                        if (key == "audio"){
                            const binaryAudioData = atob(jsonResponse["audio"]);
                            // Create a Uint8Array from the binary data
                            const uint8Array = new Uint8Array(binaryAudioData.length);
                            for (let i = 0; i < binaryAudioData.length; i++) {
                                uint8Array[i] = binaryAudioData.charCodeAt(i);
                            }
                            const outputAudioBlob = new Blob([uint8Array], { type: 'audio/wav' });
                            // Set the audio element's source to the recorded audio
                            audioPlayer.src = URL.createObjectURL(outputAudioBlob);
                        }
                    });
                    // Create a new table row for the separator
                    var separatorRow = document.createElement("tr");

                    // Create separator cell
                    var separatorCell = document.createElement("td");
                    separatorCell.colSpan = 2; // Span across two columns
                    separatorCell.textContent = "---------------------------------------------------------------";

                    // Append the separator cell to the separator row
                    separatorRow.appendChild(separatorCell);

                    // Append the separator row to the table
                    table.appendChild(separatorRow);
                };

                socket.onclose = (event) => {
                    if (event.wasClean) {
                        console.log('Closed cleanly, code=${event.code}, reason=${event.reason}');
                    } else {
                        console.error('Connection died');
                    }
                };
                
                mediaRecorder.start();
                isRecording = true;
                
                // Send audio every second
                setInterval(() => {
                    if (isRecording) {
                        mediaRecorder.stop();
                        mediaRecorder.start();
                    }
                }, 2000);

            } catch (error) {
                console.error('Error accessing the microphone:', error);
            }

        }
        // event listener for start button
        startButton.addEventListener('click', async () => {
            if (startButton.textContent == "Start"){
                startStreaming();
                startButton.textContent = "Stop";
                isRecording = true;
                pauseButton.removeAttribute('disabled');
            }else{
                startButton.textContent = "Start";
                mediaRecorder.stop();
                isRecording = false;
                pauseButton.setAttribute('disabled', 'disabled');
            }

        });
        // event listener for pause button
        pauseButton.addEventListener('click', () => {
            if (pauseButton.textContent == "Pause") {
                mediaRecorder.pause();
                pauseButton.textContent = "Resume";
                isRecording = false;
            } else {
                isRecording = true;
                mediaRecorder.resume();
                pauseButton.textContent = "Pause";
            }
        });
    </script>


</body>
</html>
